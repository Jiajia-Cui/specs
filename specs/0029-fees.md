
# WIP Fees on Vega

Fees are incurred on every trade on Vega. 

An order may cross with more than one order, creating multiple trades. Each trade incurs a fee.

## Collecting fees

In general the trading fee can be (we could have more general non-affine functions but I don't see why):

total_fee = infrastructure_fee + maker_fee + liquidity_fee

infrastructure_fee = fee_factor[infrastructure] * trade_value_for_fee_purposes
maker_fee =  fee_factor[maker]  * trade_value_for_fee_purposes
liquidity_fee = fee_factor[liquidity] * trade_value_for_fee_purposes

Fees are collected in the settlement currency of the market.

Note maker_fee = 0 if there is no maker, taker relationship between the trading parties.

The fee factors are calculated by:

_Factors_
infrastructure: staking/governance system/engine (network wide)
maker: market framework / market making (may be per market or network-wide?)
liquidity: market making system (per market)
The method of calculation of these values is out of scope for this spec. If the fees MVP is built before the contributing part of the system that would calculate the fee factor, a static (but changeable by governance as normal) network parameter can be substituted for each missing calculation. Realistic values might be: fee_factor[liquidity] = 0.1%, fee_factor[infrastructure] = 0.05%, fee_factor[maker] = 0.025%.

trade_value_for_fee_purposes:
* refers to the amount from which we calculate fee, (i.e. for futures, the trade's notional value.)
* trade_value_for_fee_purposes is defined on the Product and is a function that may take into account other product parameters 

Initially, for futures, the trade_value_for_fee_purposes = notional volume of the trade = size_of_trade * price_of_trade

### Collecting and Distributing Fees

Fees are incurred immediately at the point of trade from the margin balance of the liable trader, and if insufficient balance then the trade cannot occur.

The transfer of fees must be completed and represented in the trader's balances before any risk / margin calculations that use those balances.

infrastructure_fee: transferred to infrastructure fee pool for that asset
maker_fee: transferred to the relevant party
liquidity_fee: transferred to market-maker fee pool for that market

Note, further distribution of the infrastructure_fee and liquidity_fee are covered in future specs (market making and validator specs).

### During Continuous Trading

The "aggressor or price taker" of each trade is the participant who submitted / amended the incoming order that caused the trade  (including automatic amendments like pegged orders).

The "aggressor or price taker" pays the fee. The "passive or price maker" party is the participant in the trade whose order was hit (i.e. on the order book prior to the uncrossing that caused this trade)

### Normal Auctions (including market protection and opening auctions)

During normal auctions there is no "price maker" both parties are "takers". Each side in a matched trade should contribute 1/2 of the infrastructure_fee + liquidity_fee. Note that this does not include a maker fee. 


### Frequent Batch Auctions

Order that entered the book in the current batch are considered aggressive orders. This means that in some cases both sides of a trade will be aggressors in which case the fee calculation for normal auctions applies. Otherwise, the fee calculation for continuous trading applies.

### Position Resolution 

During position resolution all of the parties being liquidated share the total fee for the network order, pro-rated by the size of position. As for fees in other cases, the fee is taken out of the margin account for the liable traders (the insurance pool is not used to top up fees that cannot be paid).

## Acceptance Criteria

[ ] - changing parameters does change the fee level appropriately
