
# WIP Fees on Vega

Fees are incurred on every trade on Vega. 

An order may cross with more than one order, creating multiple trades. Each trade incurs a fee.

## Calculating fees

The trading fee is:

total_fee = infrastructure_fee + maker_fee + liquidity_fee

infrastructure_fee = fee_factor[infrastructure] * trade_value_for_fee_purposes
maker_fee =  fee_factor[maker]  * trade_value_for_fee_purposes
liquidity_fee = fee_factor[liquidity] * trade_value_for_fee_purposes

Fees are calculated and collected in the settlement currency of the market from the margin account.

Note maker_fee = 0 if there is no maker, taker relationship between the trading parties.

The fee factors are calculated by:

_Factors_
infrastructure: staking/governance system/engine (network wide)
maker: market framework / market making (may be per market or network-wide?)
liquidity: market making system (per market)
The method of calculation of these values is out of scope for this spec. If the fees MVP is built before the contributing part of the system that would calculate the fee factor, a static (but changeable by governance as normal) network parameter can be substituted for each missing calculation. Realistic values might be: fee_factor[liquidity] = 0.001 = 0.1%, fee_factor[infrastructure] = 0.0005 = 0.05%, fee_factor[maker] = 0.00025 = 0.025%.

trade_value_for_fee_purposes:
* refers to the amount from which we calculate fee, (i.e. for futures, the trade's notional value.)
* trade_value_for_fee_purposes is defined on the Product and is a function that may take into account other product parameters 

Initially, for futures, the trade_value_for_fee_purposes = notional volume of the trade = size_of_trade * price_of_trade

### Securing Fees ### 

The total_fee required for each trade can be calculated when the order is submitted but before it's placed on the book. 
At this stage the order may end up being aggresive (market order, limit order or pegged order that's moving) so the party submitting the trade will be liable to pay the fee. 
Thus the total_fee amount should be trasferred from the general account to the margin account *before* the trade is placed on the order book.  
If the general account has insufficient balance then the order will be rejected should not make it onto the book (pegged order should be cancelled). 
For the purposes of securing fees we should treat amends as new orders (so collect the fee on order amend as above).

If the order does not result in a trade, the order becomes a limit order on the book, and the fee amount will be released from the margin account automatically if the value of the margin account is above the release level (see 0010-margin-orchestration.md, Releasing collateral section). 

### Collecting and Distributing Fees

Fees are incurred immediately at the point of trade from the margin balance of the liable trader. There always must be sufficient balance in the margin account for both fee and margin since the required amount was transferred from general to margin account before the order was placed on the book. 

The transfer of fees must be completed and represented in the trader's balances before any risk / margin calculations that use those balances.

infrastructure_fee: transferred to infrastructure fee pool for that asset
maker_fee: transferred to the relevant party
liquidity_fee: transferred to market-maker fee pool for that market

Note, further distribution of the infrastructure_fee and liquidity_fee are covered in future specs (market making and validator specs).

### During Continuous Trading

The "aggressor or price taker" of each trade is the participant who submitted / amended the incoming order that caused the trade  (including automatic amendments like pegged orders).

The "aggressor or price taker" pays the fee. The "passive or price maker" party is the participant in the trade whose order was hit (i.e. on the order book prior to the uncrossing that caused this trade)

### Normal Auctions (including market protection and opening auctions)

During normal auctions there is no "price maker" both parties are "takers". Each side in a matched trade should contribute 1/2 of the infrastructure_fee + liquidity_fee. Note that this does not include a maker fee. 


### Frequent Batch Auctions

Order that entered the book in the current batch are considered aggressive orders. This means that in some cases both sides of a trade will be aggressors in which case the fee calculation for normal auctions applies. Otherwise, the fee calculation for continuous trading applies.

### Position Resolution 

During position resolution all of the parties being liquidated share the total fee for the network order, pro-rated by the size of position. As for fees in other cases, the fee is taken out of the margin account for the liable traders (the insurance pool is not used to top up fees that cannot be paid).

## Acceptance Criteria

[ ] - Fees are collected during continuous trading and auction modes and distributed to the appropriate accounts, as described above.
[ ] - Fees are debited from the margin account on any market orders that during continuous trading, the price maker gets the appropriate fee credited to their margin account and the remainder is split between the market making pool and staging pool.
[ ] - Fees are debited from the margin account on any "aggressive / price taking" limit order that executed during continuous trading, the price maker gets the appropriate fee credited to their margin account and the remainder is split between the market making pool and staging pool. 
[ ] - Fees are debited from the margin account on any "agressive / price taking" pegged order that executed during continuous trading, the price maker gets the appropriate fee credited to their margin account and the remainder is split between the market making pool and staging pool. 
[ ] - During auctions, each side of a trade is debited 1/2 (infrastucture_fee + liquidity_fee) from their margin account. The infrastucture_fee fee is credited to the staking pool, the liquidity_fee is credited to the market making pool.
[ ] - During continuous trading, if a trade is matched and the agressor / price taker has insufficient balance in their margin account, then the trade doesn't execute.
[ ] - During auctions, if either of the two sides has insufficient balance in their margin account, the trade doesn't execute.
[ ] - Changing parameters (via governance votes) does change the fees being collected appropriately even if the market is already running. 
[ ] - When an order is submitted, if the general account of the party doesn't contain sufficient amount for the fee, to be transferred to the margin account, then the order is rejected (pegged order removed, amend not accepted). This should be tested with a simple risk model that has *zero* risk factors. 

