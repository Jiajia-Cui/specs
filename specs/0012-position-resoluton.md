# Position Resolution

Position resolution is the mechanism which deals with closing out distressed positions on a given market. It is instigated when one or more participant's collateral balance is insufficient to fulfil their settlement or margin liabilities.

## Position resolution algorithm

See [Whitepaper](../product/wikis/Whitepaper), Section 5.3 , steps 1 - 3

1. Any trader that has insufficient capital to cover their settlement liability has all their open orders on that market are cancelled. Note, despite this potentially freeing up margin for the trader, we don't re-look at their collateral utilisation. They remain a 'distressed trader' and position resolution continues. The market may at any point in time have multiple distressed traders that require position resolution. They are 'resolved' together in a batch.

2. The batch of distressed open positions that require position resolution may be comprised of a collection of long and short positions. The network calculates the overall net long or short position. This tells the network how much volume (either long or short) needs to be sourced from the order book. For example, if there are 3 distressed traders with +5, -4 and +2 positions respectively.  Then the net outstanding liability is +3. If this is a non-zero number, do Step 3.

3. This net outstanding liability is sourced from the market's order book via a single market order (in above example, that would be a market order to sell 3 on the order book). The network is the counterpart of all trades that result from this single market order. The network now has a position (until conclusion of Step 4) which is comprised of a set of trades that transacted with the non-distressed traders on the order book. Note, any of the non-distressed traders who through this action have closed out volume need to have these settled against their specific close out price. This should happen after Step 5 to ensure we don't bankrupt the insurance pool before collecting the distressed trader's collateral.  This has been included as Step 6.

4. The system then generates a set of trades with all the bankrupt traders all at the volume weighted average price of the network's (new) open position. In above example, the network would sell 5, buy 4 and sell 2 to the three traders respectively. The open positions of all the "distressed" traders is now zero and the networks position is also zero. Note, no updates to the _Mark Price_ should happen as a result of these trades (as this would erroneously trigger a market-wide mark to market settlement and potentially lead to cascade close outs).

5. All bankrupt trader's remaining collateral in their margin account for this market is confiscated to the market's insurance pool.

6. If Step 3 occurred, settle the closed out volume generated by the network trading on the order book.

## Acceptance Criteria

* [ ] All orders of "distressed traders" are cancelled
* [ ] Open positions of distressed traders are closed
* [ ] One market order is submitted for the net liability
* [ ] Mark Price is never updated during position resolution
* [ ] Non-distressed traders who trade with the network because their open orders are hit during the close out trade have their positions settled correctly.


## Scenarios

